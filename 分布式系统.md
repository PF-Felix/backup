# 分布式系统的CAP定理

==Consistency（一致性）==

分布式系统中的所有数据备份在同一时刻是否是同样的值

- 如果某个节点更新了数据，其他节点如果都能读取到这个最新的数据就称为强一致
- 如果有某个节点没有读取到就是不一致
- 之后能读取到的话就是最终一致（BASE理论）

==Availability（可用性）==

集群中一部分节点故障后，集群整体是否还能响应客户端的请求（有数据就行，不管它对不对）

==Partition tolerance（分区容忍性）==

系统中任意信息的丢失或失败不会影响系统的继续运作

==CAP三个指标三者不可得兼，只能三选二==

==P是必须满足的==

举例说明：如果选择了 CA 放弃了 P，当发生分区现象时，为了保证一致性必须拒绝请求，但是 A 又不允许；因此 P 是必须满足的

如何保证P？做数据冗余，例如 mysql、redis、zookeeper

==为什么不能同时满足CA？==

假设用户向服务1 发送了写请求更改了数据，由于网络断开，这个更新同步不到服务2
此时如果又有一个读请求发给了服务2
1、读取成功但是读到的不是最新数据（不满足一致性）
2、阻塞等待直到网络恢复，服务2 数据得到同步之后再返回给用户（不满足可用性）

==CP、AP 如何取舍？==

看业务的容忍度

不错的策略是保证 AP 兼顾C（舍弃强一致，保证最终一致）

==BASE理论==

BASE 是这三个短语的缩写

- Basically Available（基本可用）（允许损失部分可用性，但绝不是不可用）
- Soft state（软状态）（允许请求与数据同步成功之间存在中间状态）
- Eventually consistent（最终一数性）

其核心思想就是：即使无法做到强一致，应该采用适当的方式达到最终一数性

# 分布式幂等性如何保证

类似的问题：重复消费、重复提交

什么是幂等性？

两次操作造成的结果无差别

解决方案

1、数据带上版本号（对业务有入侵，不推荐）
2、数据库中新建去重表，将消息ID插入，只有一个能插入成功（Redis setNx 也可以实现）
3、重复提交可以使用 token 解决，提交时 token 失效下发新 token

# 分布式锁

TODO
